# 鸿蒙Flutter三方库适配指南：插件开发

欢迎继续学习鸿蒙Flutter三方库适配指南系列教程。在上一节中，我们学习了插件适配的基本原理，今天我们将进入实践环节，详细介绍如何在鸿蒙平台上开发一个Flutter插件。这部分内容将为视频教程和PPT展示提供素材。

## 引言

大家好，欢迎来到鸿蒙Flutter插件开发实战教程。在这一节中，我们将通过一个具体的示例，演示如何从零开始开发一个鸿蒙平台的Flutter插件。我们实现一个三方库 DeviceIMEI 的适配。

在开始之前，请确保您已经安装了鸿蒙开发环境，包括DevEco Studio和Flutter SDK。

### 第一部分：项目结构介绍

首先，让我们了解一下Flutter插件项目的标准结构：

```
my_plugin/
├── lib/                    # Dart代码目录
├── android/                # Android平台实现
├── ios/                    # iOS平台实现
├── ohos/                # 鸿蒙平台实现（我们重点关注）
├── example/                # 示例项目
└── pubspec.yaml            # 插件配置文件
```

对于鸿蒙平台，我们需要特别关注 ohos，这是存放鸿蒙平台特定代码的地方。


### 分析原插件功能

1.插件地址：https://pub.dev/packages/device_imei

镜像地址：https://gitcode.com/zacksleo/device_imei

2.插件提供了获取设备IMEI的API，该API在Android和iOS上有不同的实现，如果在鸿蒙平台，则可以使用 [OAID](https://developer.huawei.com/consumer/cn/doc/HMSCore-Guides/oaid-0000001050783198)实现类似功能。
3. ArkTS 获取 OAID 时，需要申请权限 `ohos.permission.APP_TRACKING_CONSENT`，并集成 `@kit.AdsKit`。

### 第二部分：创建插件项目

让我们通过Flutter CLI 添加鸿蒙平台实现支持：

```bash
flutter create . --template=plugin --platforms=ohos --org nl.u2312.app_set_id
```

创建后，我们根据提示，编辑 pubspec.yaml 文件：

```yaml
      ohos:
        package: nl.u2312.app_set_id
        pluginClass: AppSetIdPlugin
```

接下来运行 `flutter pub get`



### 配置权限

修改 ohos/src/main/module.json5 文件，添加如下内容

```json
    "requestPermissions": [
      {
        "name": "ohos.permission.APP_TRACKING_CONSENT",
        "reason": "$string:app_tracking_permission_reason",
        "usedScene": {
          "abilities": [
            "EntryAbility"
          ],
          "when": "inuse"
        }
      }
    ]
```

添加文件 ohos/src/main/resources/base/element/string.json

```json
{
  "string": [
    {
      "name": "app_tracking_permission_reason",
      "value": "获取 OAID 设备标识符"
    }
  ]
}
```

## 实现ArkTS端接口

```ts
import { abilityAccessCtrl, common, PermissionRequestResult } from '@kit.AbilityKit';
import hilog from '@ohos.hilog';
import { advertising, identifier } from '@kit.AdsKit';
```

```ts
 async onMethodCall(call: MethodCall, result: MethodResult): Promise<void> {
    if (call.method == "getIdentifier") {
      const oaid = await this.requestOAID(getContext());
      result.success(oaid)
    } else {
      result.notImplemented()
    }
  }
```

```ts
  async requestOAID(context: Context): Promise<string | undefined> {
    let isPermissionGranted: boolean = false;
    try {
      const atManager: abilityAccessCtrl.AtManager = abilityAccessCtrl.createAtManager();
      const result: PermissionRequestResult =
        await atManager.requestPermissionsFromUser(context, ['ohos.permission.APP_TRACKING_CONSENT']);
      isPermissionGranted = result.authResults[0] === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED;
    } catch (err) {
      hilog.error(0x0000, TAG, `Failed to request permission. Code is ${err.code}, message is ${err.message}`);
    }
    if (isPermissionGranted) {
      hilog.info(0x0000, TAG, 'Succeeded in requesting permission');
      try {
        const oaid = await identifier.getOAID();
        hilog.info(0x0000, TAG, 'Succeeded in getting OAID');
        return oaid;
      } catch (err) {
        hilog.error(0x0000, TAG, `Failed to get OAID. Code is ${err.code}, message is ${err.message}`);
      }
    } else {
      hilog.error(0x0000, TAG, 'Failed to request permission. User rejected');
    }
    return undefined;
  }
```


## 实战总结与关键要点

在完成上述开发步骤后，我们可以总结出一些关键的技术要点和最佳实践：

### 插件开发核心概念
Flutter插件是连接Dart代码与各平台原生功能的桥梁。通过MethodChannel进行方法调用，可以实现跨平台的功能扩展。针对鸿蒙平台开发插件，能够充分利用HarmonyOS特有的系统能力。

### 项目结构最佳实践
合理的项目结构是插件可维护性的基础。除了标准的`lib`、`android`、`ios`目录外，为鸿蒙平台单独设立`harmony`目录，有助于代码的组织和未来的平台扩展。

### 开发流程标准化
虽然当前Flutter CLI尚未原生支持鸿蒙平台，但通过手动创建`harmony`目录并添加必要的配置文件（如`module.json5`和`package.json`），我们可以建立一套标准化的开发流程。

### Dart端设计原则
Dart端应提供简洁、类型安全的API接口。使用`assert`进行参数校验，通过`try-catch`处理平台异常，向调用者提供清晰的错误信息，这些都是良好的编程实践。

### 鸿蒙原生实现要点
使用ArkTS实现时，需正确初始化`MethodChannel`并设置方法调用处理器。每个方法调用都应返回Promise以支持异步操作，并妥善处理未知方法调用的情况。

### 插件生命周期管理
插件应在应用启动时正确初始化。通过在鸿蒙应用的Ability或Extension入口处实例化插件处理器，确保其在整个应用生命周期内可用。

## 总结

通过本节的学习，我们掌握了在鸿蒙平台上开发Flutter插件的基本流程：

1. 创建标准Flutter插件项目结构
2. 手动添加鸿蒙平台支持文件
3. 实现Dart端接口
4. 使用ArkTS开发鸿蒙原生功能
5. 正确注册和初始化插件

虽然目前Flutter对鸿蒙平台的支持还在不断完善中，但我们可以通过手动添加的方式来实现插件开发。随着生态的发展，相信未来会有更加便捷的工具和更好的支持。


最终项目地址：https://gitcode.com/zacksleo/device_imei

在下一节中，我们将学习如何测试和调试我们开发的插件，确保它们能够在鸿蒙设备上稳定运行。

感谢观看本次教程，如果有任何问题，欢迎在评论区留言讨论。

## 参考资料

- [设备标识服务-OAID](https://developer.huawei.com/consumer/cn/doc/HMSCore-Guides/oaid-0000001050783198)
- [Ads-Kit-ArkTS](https://gitee.com/harmonyos_samples/ads-kit-sample-code-client-demo-arkts)
- [开放权限](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/permissions-for-all-user#ohospermissionapp_tracking_consent)
- [ohos平台适配flutter三方库指导](https://gitcode.com/openharmony-tpc/flutter_samples/blob/master/ohos/docs/07_plugin/ohos%E5%B9%B3%E5%8F%B0%E9%80%82%E9%85%8Dflutter%E4%B8%89%E6%96%B9%E5%BA%93%E6%8C%87%E5%AF%BC.md)